---
title: "Hedonic House Prisce Model King County"
author: "Sognefest & Jones (2023)"
date: "Innleveringsfrist: 20.11.2023"
format: html
format: pdf
abstract: "The Hedonic Houseprice model with maps....."
editor: visual
bibliography: [King_county.bib]
output-file: Msb205.qmd
page-layout: full
number-sections: true
papersize: a4
---

```{r}
#| label: setup
#| message: false
library(dplyr)
library(sf)
library(Jmisc)
library(tidyverse)
library(ggplot2)
library(sp)
library(spdep)
library(spatialreg)
library(spData)
library(huxtable)
library(knitr)
library(foreign)
```

# Oppgave 1

```{r Oppgave 1}
kc_house_data <- read.csv("kc_house_data.csv")
kc_house_data$date <- lubridate::ymd_hms(kc_house_data$date) #lager datoobjekt

kc_house_data <- kc_house_data %>%
  mutate(year = year(date),
         month = month(date),
         #nye variabler for date, month, year
         day = day(date)
         ) %>% 
  ##sortere datasett basert på dato
  arrange(desc(date)) %>% 
  #behold bare siste salg
  distinct(id, .keep_all = TRUE) 
```

```{r}
kc_house_data_sf <- kc_house_data |> 
  #Bruk st_as_sf() til å konvertere house data til 
  # et sf objekt vha. long lat og sett til geografisk 
  # projeksjon, dvs EPSG:4326.
  st_as_sf(
    coords = c("long", "lat"), 
    crs = 4326
    ) |> 
  #endre til EPSG:2926
  st_transform(2926)
```

Bruk koordinatene fra Seattles wikipedia-side (øvre høyre hjørne, klikk linken så får dere koordinatene i desimalform) og sett dette punktet som CBD for Seattle.

```{r}
#| label: Oppgave 1 - videre, cbd
# datasett med koordinatene
cbd <- data.frame(long = -122.333056, lat = 47.609722) 
```

```{r}
cbd_sf <- cbd |> 
  # til sf
  st_as_sf(
    coords = c("long", "lat"), 
    crs = 4326
    ) |> 
  # til ESPG 2926
  st_transform(2926) 
```

```{r}
#| label: avstand til CBD
kc_house_data_sf <- kc_house_data_sf %>% select(-starts_with("geometry."), -starts_with("avstand_til_cbd.."), -starts_with("distance_cbd"))

#Konverter dette punktet til EPSG:2926. Finn avstanden mellom dette punktet og samtlige hus i datasettet i luftlinje. Konverter avstandene til km og legg dem i variabelen dest_CBD i kartet med husdata.
avstand_til_cbd <- st_distance(kc_house_data_sf, cbd_sf) #avstand til cbd i luftlinje
avstand_til_cbd_km <- avstand_til_cbd * 0.0003048 #1 fot er lik 0.0003048 kilometer
kc_house_data_sf$dest_CBD <- avstand_til_cbd_km #inn i datasett
```

```{r Oppgave 1 ferdig, må rydde}
rm(cbd, cbd_sf, kc_house_data) #fjerne unødvendige datasett
kc_house_data_oppg1 <- kc_house_data_sf #endre ferdig datasett til "kc_house_data_oppg1"
rm(kc_house_data_sf) #fjerne 
```

# Oppgave 2

```{r Laste inn shp-fil}
#Last ned WADOH Environmental Health Disparities Index Calculated for King County. 
file_path <- "Data/WADOH_Environmental_Health_Disparities_Index_Calculated_for_King_County___wadohehdindex_area.shp"
WADOH_King_County <- st_read(file_path) #Les inn .shp filen WADOH King County.
```

```{r Velge ut variabler}
#Plukk ut variablene angitt tidligere i oppgaven.
kc_wadoh_map <- WADOH_King_County %>% 
  select(
  GEO_ID_TRT,
  EHD_percen,#Environmental Health Index, weighted score many vars
  linguist_2,#Pop. age 5+ speaking English less than "very well"
  poverty_pe,#Percentage people living in poverty
  transporta,#% of income spent on transportation median family in tract
  unemploy_2,#percentage unemployed
  housing_pe,#% of households in group "Unaffordable Housing" (>30% inc.)
  traffic_pe,#% of pop. near heavy traffic roadways
  diesel,# nox consentration
  ozone,# ozone consentration
  PM25, # consentration of Particulate Matter in air
  toxic_rele, # Toxic release from factories
  hazardous_, # Hazardous Waste Treatment Storage and disposal Facilities
  lead_perce, # measure of Lead paint in houses
  superfund, # Proximity to contaminated sites on national list
  facilities, # Proximity to Risk Management Plan Facilities
  wastewater, # Proximity to wastewater facilities
  sen_pop_pe, # % pop. over 65
  socio_perc # score social economic determants, low best
  )
```

```{r}
#Transponer kartet til projeksjonen EPSG:2926
# Denne trengs ikke (ALLE variablene)
# WADOH_King_County <- st_transform(WADOH_King_County, 2926)
# Denne inneholder variablene vi trenger
kc_wadoh_map <- st_transform(kc_wadoh_map, 2926)
```

Bruker en spatial join for å legge områdevariablene til husvariablene.
Hvert hus får verdier utfra hvilket område de ligger i.
I tillegg får vi med område (tract) variabelen slik at det blir enkelt å legg til familieinntekt og rase variablene.

```{r}
kc_house_data_oppg1 <- kc_house_data_oppg1 |> 
  st_join(kc_wadoh_map)
```

## Inntekt i WADOH_K_C

Dette ordnet vi vel opp i på fredag.
Skjønner ikke hvorfor dere insisterer på å bruke disse .csv filene av ukjent opphav.
Oppgaveteksten forklarer hvor dere kan laste ned census-dataene.
Når dere pakker ut denne .zip filen får dere en mappe kalt censusSHP.
Jeg har laget en slik mappe nå i mappen Data og lagt inn filene dere trenger.

```{r}
#|  label: Legge inn datasett. 
#  Dette fikk jeg ikke lastet ned som dbf-fil
# Se nedenfor
#acs_b19101_familyincome <- read.csv("acs_b19101_familyincome.csv")
#view(acs_b19101_familyincome)
acs_b19101_familyincome <- read.dbf(
  file = "Data/censusSHP/acs_b19101_familyincome.dbf",
  as.is = TRUE
)
```

```{r endre inntektsvariabler}
 acs_b19101_familyincome <- acs_b19101_familyincome %>% 
    mutate(low = (E19101138 + E19101139 + E19101140 + E19101141 + 
                      E19101142 + E19101143)/E19101137) %>% 
    mutate(mid = (E19101144 + E19101145 + E19101146 + E19101147 + 
                      E19101148 + E19101149)/E19101137) %>% 
    mutate(high = (E19101150 + E19101151 + E19101152 + E19101153)/E19101137)
```

```{r}
#Select income groups, 
acs_b19101_familyincome <- acs_b19101_familyincome %>% 
    select(GEOIDTRT, low, mid, high) 
```

## Etnisitet i WADOH K_C

```{r}
# Hvorfor leser dere inn denne? 
#acs_b02001_race <- read_csv("acs_b02001_race.csv")
#View(acs_b02001_race)
acs_b02001_race <- read.dbf(
  file = "Data/censusSHP/acs_b02001_race.dbf",
  as.is = TRUE
)
```

```{r endre etnisitet-variabler}
acs_b02001_race <- acs_b02001_race %>%
  #fjerner M-variabler
  select(-starts_with("M")) %>% 
  mutate(
    total = E02001001,
    hvit_alene = E02001002,
    svart_alene = E02001003,
    asiatisk_alene = E02001005,
    andre_alene = E02001004 + E02001006 + E02001007,
    blandet = E02001008 + E02001009 + E02001010
  )
```

```{r}
#| label:  Lage andel-variabler
acs_b02001_race <- acs_b02001_race %>%
  mutate(
    andel_hvit_alene = hvit_alene / total * 100,
    andel_svart_alene = svart_alene / total * 100,
    andel_asiatisk_alene = asiatisk_alene / total * 100,
    andel_andre_alene = andre_alene / total * 100,
    andel_blandet = blandet / total * 100
  )
```

Da er familieinntekt og rase variabelen klar.
Disse må legges til kc_house_data_oppg1 som inneholder husdata og område (tract) variabler.
kc_house_data_oppg1 har nå også variabelen GEO_IDTRT som vi fikk fra spatial join med kc_wadoh_map.
Gjør det enkelt å legge til familieinntekt og rase data.
Eneste vi må huske er at tract variabelen heter GEOIDTRT i disse filene.

```{r}
#kc_house_data_oppg1 

tmp <- kc_house_data_oppg1 |> 
  # trenger ikke å gjøre en spatial join siden vi har tract ID
  left_join(acs_b02001_race, join_by(GEO_ID_TRT == GEOIDTRT)) |>
  left_join(acs_b19101_familyincome, join_by(GEO_ID_TRT == GEOIDTRT)) 
```

```{r Laste ned kart}
file_path2 <- "Data/Kart/tracts10.shp"
tracts10 <- st_read(file_path2) #Les inn .shp-filen.
#view(tracts10)
```

```{r etnisitet inn i WADOH_K_C}
acs_b02001_race$GEO_ID_TRT <- as.character(acs_b02001_race$GEO_ID_TRT) #til character
WADOH_King_County <- WADOH_King_County %>%
  # GEO_ID_TRT er tract name i 
  left_join(acs_b02001_race, join_by(GEO_ID_TRT ==  )
```

```{r Sjekk områdevariablene fra WADOH vha. summary for tracts10}
summary(tracts10)
```

## 3. Hus data = Inntekt og Etnisitet

```{r}
# Convert the joining key in both dataframes to the same type if they are different
# For example, if GEO_ID_TRT is numeric in one and character in the other:

acs_b02001_race$GEO_ID_TRT <- as.character(acs_b02001_race$GEO_ID_TRT)
acs_b19101_familyincome$GEO_ID_TRT <- as.character(acs_b19101_familyincome$GEO_ID_TRT)

# Now join the datasets
joined_data <- acs_b02001_race %>%
               left_join(acs_b19101_familyincome, by = "GEO_ID_TRT")

#Removing rows with missing values
husdata <- na.omit(joined_data)


View(husdata)


```

## WADOH K_C

```{r}
# Adjust the filtering criteria 'WADOH' county, useing COUNTY_STR
acs_b02001_race$GEO_ID_TRT <- as.character(acs_b02001_race$GEO_ID_TRT) #til character
WADOH_KC_Etnisitet <- WADOH_King_County %>%
  left_join(acs_b02001_race, by = "GEO_ID_TRT")
view(WADOH_KC_Etnisitet)
```

```{r}
acs_b19101_familyincome$GEO_ID_TRT <- as.character(acs_b19101_familyincome$GEO_ID_TRT) 
#til character
WADOH_KC_income <- WADOH_King_County %>%
  left_join(acs_b19101_familyincome, by = "GEO_ID_TRT")
```

#### III)

```{r}
# Renaming the Date column to year_month
WADOH_KC_Etnisitet <- WADOH_KC_Etnisitet %>%
  rename(year_month = date)
view(WADOH_KC_Etnisitet)
```

#### IV)

```{r}
#Lagre .gpkg filen for husdataene . (Sett opsjonen append=FALSE. Ellers får dere ikke lov til å overskrive filen.)
st_write(WADOH_KC_Etnisitet, "WADOH_KC_Etnisitet.gpkg", append = FALSE)
st_write(WADOH_KC_income, "WADAOH_KC_income.gpkg", append = FALSE)

```

```{r}

```

## 4. EDA i GeoDA

#### I) Lag et nytt prosjekt i GeoDA

#### II) Last inn husdataene via .gpkg filen lagret overnfor

#### III) Generer en vekt fil utfra 3 og 10 nærmeste nabo

#### IV) Prøv å finne ut hvor de små og dyre, de store og dyre, de billige og store og de små og billige boligene ligger (prøv Bivariate Morans I)

#### V) Dere kan evt også eksprementere med SAR, SEM, og lm modeller i GeoDA
